---
title: "coords-from-kml"
author: "Tammy"
date: "May 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose
Part of creating a metadata file for BikePed Portal requires the location of flow detectors. Some users might use Google Earth to approximate multiple flow detector locations. The purpose of this document is to demonstrate how to extract all the layers within a .kml (and supposedly .kmz) file generated by Google Earth to get the required latitude and longitude coordinates for flow detectors.

## Methods & Results
Flow detector locations are based on approximate locations throughout San Francisco as described in submitted data sheets of manual bicycle counts from SFMTA for 2006. All flow detector locations were plotted in Google Earth and then exported as a .kml file. The following section shows how to extract latitude and longitude coordinates for each flow detector location from a .kml file.

```{r, results = "hide", message=FALSE, warning=FALSE}
library(tidyverse)
library(rgdal)
library(rlist)
library(leaflet)

detectors_dsn <- "data/SFMTA_detectors_2006_v2.kml"

kmllayer <- ogrListLayers(detectors_dsn)
kmllayer <- as.data.frame(kmllayer)
kmllayer <- kmllayer[-1,]
kmllayer <- as.vector(kmllayer)

allKmlLayers <- function(kmlfile){
  mykml <- list()
  for (i in 1:length(kmllayer)) {
    mykml[i] <- readOGR(detectors_dsn, kmllayer[i], require_geomType = "wkbPoint")
  }
  names(mykml) <- kmllayer
  return(mykml)
}

detectors_all <- allKmlLayers(detectors_dsn)

test <- function(layers){
  layers <- list()
  for (i in 1:length(detectors_all)) {
    layer_name <- kmllayer
    df <- data.frame(detectors_all[[i]])
    layers[[i]] <- df
  }
  return(layers)
}  

test_output <-test(detectors_all)

detectors_df <- list.rbind(test_output) %>%
  select(geom_id = Name, longitude = coords.x1, latitude = coords.x2)
```

With all latitude and longitude coordinates extracted for each flow detector location we can map the points to double check the locations.

```{r visual location}
sf_2006 <- leaflet() %>%
  setView(lng = -122.4188, lat = 37.7759, zoom = 12) %>%
  addProviderTiles(providers$Esri.WorldStreetMap) %>%
  addMarkers(data = detectors_df, lng = ~longitude, lat = ~latitude, popup = ~as.character(geom_id),
             label = ~as.character(geom_id), group = "geom_id")
sf_2006
```

